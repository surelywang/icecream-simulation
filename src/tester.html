<html lang="en">

<head>
	<title>Ice Cream Simulation</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body {
			font-family: Monospace;
			margin: 0px;
			overflow: hidden;
		}
		#info {
			color: #fff;
			position: absolute;
			top: 10px;
			width: 100%;
			text-align: center;
			z-index: 100;
			display:block;
		}
		#info a {
			color: #ff0080;
			font-weight: bold;
		}
	</style>
</head>

<body>
<div id="info">Ice Cream Simulation | Natalie Khamphanh, Lauren Martini, and Shirley Wang</div>

<script src="../build/three.js"></script>
<script src="js/WebGL.js"></script>
<script>

// Base code = https://codepen.io/kaigth/
// Reference 2 = https://codepen.io/kekkorider/pen/BRrgbY/

// Setup Particles
var particleSet = [],
    particleCount = 200,
    spreadMin = 0.01,
    spreadMax = 0.08,
    speed = 1000, // higher means slower
    timeToSlow = 1;

var SW = window.innerWidth, SH = window.innerHeight;
var scene = new THREE.Scene();
var camera, renderer;
var icemat, icedrip;

// var backgroundMesh, backgroundScene, backgroundCamera;


var count = 0;


init();
render();


// Intiialize scene
function init() {

	// Set camera
	camera = new THREE.PerspectiveCamera(60, SW / SH, 0.1, 1000);
    camera.position.z = 5;

    // Set renderer
	renderer = new THREE.WebGLRenderer();
	renderer.setSize(SW, SH);
	document.body.appendChild(renderer.domElement);

	// Add lightss to scene
	var ambient = new THREE.AmbientLight(0xffffff);
	var spot = new THREE.SpotLight( 0xFFFFFF );
	var point = new THREE.DirectionalLight( 0xffffff );
	spot.position.set( 1, 3, 5 );
	spot.position.set( 0, 1, 1 ).normalize();
	scene.add( spot );
	scene.add( ambient );
	scene.add( point );

	// Load all the textures we need
    var loader = new THREE.TextureLoader();
		loader.crossOrigin = "";
		var texture1 = loader.load('https://envato-shoebox-0.imgix.net/c4c9/3704-8a4d-4315-8997-69a5b832e534/DSC_9637.jpg?auto=compress%2Cformat&fit=max&mark=https%3A%2F%2Felements-assets.envato.com%2Fstatic%2Fwatermark2.png&markalign=center%2Cmiddle&markalpha=18&w=700&s=45fd8158a2ca535f0d006114df005daf');
		var texture2 = loader.load('https://11907110f9dd2f4142e1-7ffe570da0ff54a0cf08d83fa799f23c.ssl.cf1.rackcdn.com/Food_B_0045.jpg');
		var texture3 = loader.load('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSHfgGXhdWkxvY_uM4Yn4L90G6ELF9Ki7DNXBfJ4K278g2LPiB7');
		var texture4 = loader.load('https://upload.wikimedia.org/wikipedia/commons/4/45/Blender3D_BW_Grid_256.png');

	// Temp 2D cone background for testing
	// backgroundMesh = new THREE.Mesh(
	// 	new THREE.PlaneGeometry(5, 5, 0),
	// 	new THREE.MeshBasicMaterial( {
	// 		map: texture3
	// 	}));
	// backgroundMesh.position.y = -2.25;
	// backgroundMesh.material.depthTest = false;
	// backgroundMesh.material.depthWrite = false;
	//scene.add(backgroundMesh);

    icemat = new THREE.MeshPhongMaterial({
      map: texture1,
      transparent: false,
      bumpMap: texture2,
      displacementMap: texture1,
      displacementScale: 0.5
    });

    icedrip = new THREE.MeshPhongMaterial({
      map: texture1,
      transparent: false,
      bumpMap: texture2,
      displacementMap: texture1,
      displacementScale: 0.1
    });

    var cone_geo = new THREE.ConeGeometry(1, 3, 10);
    var cone_mat = new THREE.MeshPhongMaterial({
      map: texture3,
      transparent: false,
      bumpMap: texture2
    });
    var cone = new THREE.Mesh(cone_geo, cone_mat);
    cone.scale.y = -1;
    cone.position.y = -0.4;
    scene.add(cone)
        
    var geometry = new THREE.SphereBufferGeometry(0.55, 32, 32);
    mesh = new THREE.Mesh(geometry, icemat);
    mesh.position.y = 1;
    mesh.opacity = 1;

    scene.add(mesh);
    particleSet[0] = mesh;
    
}

// Creates a new particle
function newParticle() {

  var geometry = new THREE.SphereBufferGeometry( 0.2, 32, 32 );
  // var material = new THREE.MeshBasicMaterial( {
  // 	color: 0xf3e5ab,
  // 	transparent: true } );

  var particle = new THREE.Mesh( geometry, icemat );
  return particle;

}

// Creates default particles
function makeParticles() {

  for ( var i = 1; i < 100; i++ ) {
  	var particle = newParticle();

  	particle.position.x = -0.1 + i*0.00001;
  	particle.position.y = 0.4;
  	particle.material.opacity = 1;

  	scene.add( particle );
  	particleSet.push( particle );

  }

}


function rRange(min, max) {
    return Math.random() * (max - min) + min;
}


// Looping and Rendering
function render() {

  count += 0.001;
  
  if ( particleSet.length <= particleCount ) {
    makeParticles();
  }

  for ( var i = 1; i < particleSet.length; i++ ) {
    
    particleSet[i].material.opacity -= 0.001;
    
    if ( particleSet[i].material.opacity <= 0.000 ) {
      
       particleSet[i].position.x = -0.001 * i + 0.001 * count;
       particleSet[i].position.y = 1 + count * 0.01 + 0.01;
       particleSet[i].material.opacity = 1;
    }

    // particleSet[i].position.x += (0.002 + rRange( -spreadMin, spreadMax) / speed) * timeToSlow;
    particleSet[i].position.y -= (0.002 + rRange( -spreadMin, spreadMax) / speed) * timeToSlow;
  }

  renderer.render(scene, camera);
  requestAnimationFrame(render);
  
}

</script>
</body>
</html>
